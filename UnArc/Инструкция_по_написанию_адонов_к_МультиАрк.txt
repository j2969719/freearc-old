Инструкция по написанию адонов к МультиАрк
Автор: arsvrn

Основным достоинством Multiarc'овского подхода является возможность единообразной работы с любым внешним архиватором, поддерживающим работу с командной строкой и имеющим минимально необходимый набор команд.
Это обеспечивается путем описания в ini-файле на некоем универсальном языке правил управления архиватором для выполнения стандартных операций получения листинга архива, архивации и т.д. 
Используя эти правила и язык пользователь может подключить к файл-менеджеру новый архиватор или настроить под свои нужды имеющийся в наборе. 

Для полноценной работы с архивами Multiarc должен уметь выполнять три основных типа операций. 
1. При выполнении архивирования - передача архиватору через командную строку команды на архивацию, списка управляющих режимами ключей и списка архивируемых каталогов и файлов. 
2. При выполнении извлечения из архива - передача архиватору через командную строку команды на извлечение, списка управляющих режимами ключей и списка извлекаемых каталогов и файлов. 
3. При входе в архив необходимо выполнить несколько операций. Сначала определить формат архива (и, соответственно, каким архиватором с ним работать). Потом передать выбранному архиватору через командную строку команду на вывод листинга содержимого архива со списком управляющих ключей. И, наконец, разобраться с выведенным листингом, чтобы получить список содержащихся в архиве каталогов и файлов. 
Все это описывается в ини-файле с помощью зарезервированных слов (директив) и модификаторов. Их описание приводится в ини-файлах Multiarc'a для ТС и Far. 

Применение кратко можно описать следующим образом (в скобках рядом с описываемым параметром указано для TC или Far он применим, если ничего не указано - значит применим и для Far и для ТС): 

Для каждого типа архива создается свой раздел, который начинается с заголовка имени формата архива (порядок следования директив внутри раздела значения не имеет): 

[UHArc] 
Для того, чтобы Multiarc мог обращаться к архиватору, необходимо указать путь и имя архиватора. Для ТС имя архиватора может быть задано директивой: 
Archiver = путь\имя_архиватора.расширение, например c:\bin\uharc.exe 
Далее идут описатели формата архива: 
TypeName = UHArc (Far) - (опционально) имя формата архива, при наличии переопределяет заголовок. 
ID = 55 48 41 06 - (опц) идентификатор формата. Это набор двухразрядных шестнадцатиричных чисел, уникальных для данного формата. Обычно архиватор записывает в файл свой идентификатор, чтобы потом его опознать. В примере - идентификатор для UHArc 0.6. К сожалению, в документации на архиваторы ID встречается крайне редко, поэтому его приходится искать самостоятельно. Можно, например, создать несколько архивов и сравнением найти неизменную часть. Однако, так как чаще всего в не SFX-архивах ID стоит в начале файла, его не так уж трудно определить.
IDPos = 0 - (опц) позиция кода ID в файле. В документации тоже не встречается, но чаще всего - в начале архива (=0). Если в инишнике не прописана - Multiarc ищет ID в начальной части файла (64 кб).
IDOnly = 1 (Far) - (опц) если =1, то Multiarc игнорирует расширение и определяет формат архива только по ID. Иначе используются и расширение и ID (если есть).
Extension = uha - расширение файлов данного формата архива (без точки). Для Far - только одно, для ТС - может быть несколько, разделяются запятой.
Таким образом, Extension, ID, IDPos и IDOnly - параметры, по которым Multiarc определяет формат архива.
Команда на вывод листинга архива дается архиватору в следующем формате: 
List = путь\имя_архиватора.расширение команда_листинга [опц_ключи] (Far) - например, uharc.exe l -y -d2 
или 
List = путь\имя_архиватора.расширение команда_листинга [опц_ключи] имя_архива (ТС) - например, %P l -y -d2 %AQA. Переменная %P это имя архиватора, переменная %AQA - имя архива с модификаторами (будут описаны позднее). 
Архиватор по этой команде выводит листинг архива, для разбора которого используются параметры Start, End, Format0...FormatN. 

Одно из основных достоинств Multiarc заключается в том, что с его помощью файл-менеджер может работать с архивами, как с папками. Чтобы это обеспечить, Multiarc должен уметь разбирать содержимое архива и представлять его файл-менеджеру. Поскольку Multiarc предназначен для работы с различными типами архивов, он пользуется командами соответствующих архиваторов для вывода листинга архива, затем разбирает его и передает файл-менеджеру в виде списка файлов и папок. 
Для задания Multiarc'у правил разбора листинга используются директивы Start, End, Format0...FormatN. Они прописываются в файле Multiarc.ini отдельно для каждого архиватора. 

Вот пример листинга некоего архива, выдаваемого архиватором UHArc по команде uharc l -y -d2 uha.uha. 

UHARC 0.6a ----- high compression multimedia archiver ----- BETA version 
Copyright (c) 1997-2005 by Uwe Herklotz All rights reserved 06 Feb 2005 
**** Freeware for non-commercial use **** contact: uwe.herklotz@gmx.de **** 

Processing archive "uha.uha" (created: 25-May-2005, 11:41). 

file size date time attr crc-32 
------------------------------------------------------------------------------- 
Formats\ace.fmt 
55808 27-Jan-2004 03:30:00 ---A C4500DA4 
Formats\cab.fmt 
50176 27-Jan-2004 03:30:00 ---A E59709A3 
Default.sfx 
52736 27-Jan-2004 03:30:00 ---A 5D7E432F 
RarExt.dll 
121344 27-Jan-2004 03:30:00 ---A EC5D815D 
rarreg.key 
462 29-Jan-2004 11:47:26 ---A 2FC3B32E 
Formats\tar.fmt 
54784 27-Jan-2004 03:30:00 ---A E94B8FDB 
Formats\UNACEV2.DLL 
75264 27-Jan-2004 03:30:00 ---A 237E323C 
WinRAR.exe 
843776 29-Jan-2004 11:47:38 ---A 4813E3A7 
------------------------------------------------------------------------------- 
8 files 1254350 
448857 packed (PPM-mode), ratio: 35.8%  

Как видно, в листинге имеет место быть как полезная информация (имена, даты, размеры и т.д.), так и бесполезная (для Multiarc'a) - Copyright и т.д. Директивы Start и End служат для указания Multiarc'у местоположения полезной информации. 

Start = "-------------------------------------------------------------------------------" - указывает, с какого места в выходном листинге архиватора начинается собственно листинг архива. Это просто текстовая строка, совпадение с которой Multiarc ищет в выходном листинге и со следующей начинает разбор содержимого архива. В данном примере легко заметить, что список файлов начинается после строки "---...---". Если строка в параметре Start начинается с символа "^", то в качестве образца для поиска совпадения используется строка со следующего после "^" символа и в листинге ищется совпадающая строка, расположенная строго в начале строки. В противном случае совпадающий текст может находиться в любом месте строки листинга. 

End = "-------------------------------------------------------------------------------" - указывает, где в выходном листинге архиватора заканчивается листинг архива. Все аналогично директиве Start. 

Директивы Format0...FormatN описывают формат, в котором выводится листинг файлов и папок. Описание формата представляет собой текстовую строку, в которой для описания формата используется набор ключевых символов: 
n - имя файла; 
e (ТС) - расширение файла; 
z - исходный размер файла; 
p - упакованный размер файла; 
c - контрольная сумма; 
d - день; 
t - месяц (в виде числа); 
TTT - месяц в виде трехбуквенного сокращения (Jan, Feb, Mar, ...); 
y - год; 
h - часы (24-х часовой формат); 
H - модификатор часов для 12-ти часового формата (a - до полудня, p - после полудня); 
m - минуты; 
s - секунды; 
a - атрибуты файла; 
. - удалить пробелы в конце имени файла и добавить имя с точкой; 
* - пропустить до первого пробела или конца строки. 

В приведенном примере листинга для каждого файла используется две строки: в первой выводится имя файла (длинное), во второй - все прочие атрибуты. Следовательно, необходимо использовать два формата (Format0 и Format1). 

В Format0 прописываем длинную строку "nnn...nnn", указывающую Multiarc'у, что в этой строке передается только имя файла: 

Format0 = "nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn" 

В Format1 необходимо с помощью ключевых символов прописать информацию о том, какие данные находятся в данном месте строки листинга (причем с точностью до позиции символа). Лучше всего это сделать, расположив строку из листинга над строкой Format и используя моноширинный шрифт (здесь пропорциональный): 

Format1 = " zzzzzzzzzz dd-TTT-yyyy hh:mm:ss aaaa cccccccc" 
" 121344 27-Jan-2004 03:30:00 ---A EC5D815D" 

Сколько позиций отвести на размер файла - неизвестно, берем для 1 Тб  

Таким образом, с помощью директив Start, End, Format0 и Format1 описывается набор правил для Multiarc'а, по которым он теперь может узнать из листинга архиватора содержимое архива и передать его файл-менеджеру. 
Далее остается описать построение команд на архивацию, разархивацию, удаление и т.д. и методы передачи архиватору списков обрабатываемых файлов и папок. 

Для того, чтобы Multiarc мог работать с различными архиваторами, он должен уметь передавать им команды для работы с архивами в соответствии с их системой команд. Для этого применяется набор директив, описывающий некий универсальный набор действий, достаточных для работы с архивами. 
Основными из них я бы назвал следующие (поддерживаются почти всеми архиваторами): 

List - команда получения листинга архива, описана выше. 

Extract (Far) - команда извлечения файлов из архива с полным путем. Формат команды: 
Extract = путь\имя_архиватора.расширение команда_извлечения_с_путем(или команда_извлечения и ключ_"с_путем") [опц_ключи] имя_архива имя_извлекаемого_файла(или список_извлекаемых_файлов). 
Например, Extract = uharc.exe x -d2 {-pw<%%P>} %%AQ @%%LQM 

Extract (TC) - команда извлечения файлов из архива без пути. Формат команды: 
Extract = путь\имя_архиватора.расширение команда_извлечения_без_пути(или команда_извлечения и ключ_"без_пути") [опц_ключи] имя_архива имя_извлекаемого_файла(или список_извлекаемых_файлов). 
Например, Extract = %P e -y -idle { %S} %AQA @%LQ 

ExtractWithoutPath (Far) - команда извлечения файлов из архива без пути. Формат команды: 
Extract = путь\имя_архиватора.расширение команда_извлечения_без_пути(или команда_извлечения и ключ_"без_пути") [опц_ключи] имя_архива имя_извлекаемого_файла(или список_извлекаемых_файлов). 
Например, ExtractWithoutPath = uharc.exe e -d2 {-pw<%%P>} %%AQ @%%LQM 

ExtractWithPath (TC) - команда извлечения файлов из архива с полным путем. Формат команды: 
Extract = путь\имя_архиватора.расширение команда_извлечения_с_путем(или команда_извлечения и ключ_"с_путем") [опц_ключи] имя_архива имя_извлекаемого_файла(или список_извлекаемых_файлов). 
Например, ExtractWithPath = %P x -y -idle { %S} %AQA @%LQ 

Add (Far) - команда добавления файлов в архив без пути. Формат команды: 
Add = путь\имя_архиватора.расширение команда_добавления_без_пути(или команда_добавления и ключ_"без_пути") [опц_ключи] имя_архива имя_добавляемого_файла(или список_добавляемых_файлов). 
Например, Add = uharc.exe a -mx -d2 -md32768 -ed+ -idle {-pw<%%P>} {%%S} %%AQ @%%LQM 

Add (ТС) - команда добавления файлов в архив с полным путем. Формат команды: 
Add = путь\имя_архиватора.расширение команда_добавления_с_путем(или команда_добавления и ключ_"с_путем") [опц_ключи] имя_архива имя_добавляемого_файла(или список_добавляемых_файлов). 
Например, Add = %P a -y -d0 -mx -md32768 -ed+ -idle -lg { %S} %AQA @%LQ 

AddRecurse (Far) - команда добавления файлов в архив с полным путем. Формат команды: 
AddRecurse = путь\имя_архиватора.расширение команда_добавления_с_путем(или команда_добавления и ключ_"с_путем") [опц_ключи] имя_архива имя_добавляемого_файла(или список_добавляемых_файлов). 
Например, AddRecurse=uharc.exe a -r+ -d2 -mx -md32768 -ed+ -idle {-pw<%%P>} %%AQ @%%LQM 

Move (Far) - команда перемещения (добавления с последующим удалением) файлов в архив без пути. Формат команды: 
Move = путь\имя_архиватора.расширение команда_перемещения_без_пути(или команда_перемещения и ключ_"без_пути") [опц_ключи] имя_архива имя_перемещаемого_файла(или список_перемещаемых_файлов). 
Например, Move = uharc.exe m -d2 -mx -md32768 -ed+ -idle {-pw<%%P>} %%AQ @%%LQM 

Move (ТС) - команда перемещения файлов в архив с полным путем. Формат команды: 
Move = путь\имя_архиватора.расширение команда_перемещения_с_путем(или команда_перемещения и ключ_"с_путем") [опц_ключи] имя_архива имя_перемещаемого_файла(или список_перемещаемых_файлов). 
Например, Move = %P m -y -d0 -mx -md32768 -ed+ -idle { %S} %AQA @%LQ 

MoveRecurse (Far) - команда перемещения файлов в архив с полным путем. Формат команды: 
Move = путь\имя_архиватора.расширение команда_перемещения_с_путем(или команда_перемещения и ключ_"с_путем") [опц_ключи] имя_архива имя_перемещаемого_файла(или список_перемещаемых_файлов). 
Например, MoveRecurse = uharc.exe m -d2 -mx -md32768 -r+ -ed+ -idle {-pw<%%P>} %%AQ @%%LQM 

Delete - команда удаления файлов из архива. Формат команды: 
Delete = путь\имя_архиватора.расширение команда_удаления [опц_ключи] имя_архива имя_удаляемого_файла(или список_удаляемых_файлов). 
Например, 
Delete = 7za.exe d -y -r0 -ms=off %%A @%%LQMN (Far) 
Delete = %P d -y %AQA @%lQ (ТС) 

Test - тест целостности архива. Формат команды: 
Test = путь\имя_архиватора.расширение команда_тестирования [опц_ключи] имя_архива 
Например, 
Test = uharc.exe t {-pw%%P} %%AQ (Far) 
Test = %P t -y -idle { %S} %AQA (TC) 

Существуют и другие, дополнительные директивы. Они описывают, например, команды создания SFX-архивов, защиты архивов и т.д. Также есть директивы для указания способа обработки ошибок, режима отладки и другие. 

Команда это строка которая содержит переменные. Эти переменные имеют знак "%" перед ними и могут быть заменены во время вызова команды. 

Список переменных команд:

%P - Длинное имя архиватора (как оно в параметре "Archiver")
%p - короткое имя архиватора (как оно в параметре "Archiver")
%A - длинное имя архивного файла 
%a - короткое имя архивного файла 
%L - имя Filelist (списка файлов). Filelist -это файл содержащий имена файлов 
     которые должны быть обработаны внешним архиватором. Имена файлов длинные. 
%l - Filelist с короткими именами файлов.
%F - имя одного файла для обработки. Архиватор будет вызван несколько раз, до тех
     пор пока все файлы не будут обработаны. 
     Эта переменная должна быть использована только если архиватор не поддерживает 
     список файлов в строке вызова.
%E<errorlevel> - максимальный допустимый код завершения (errorlevel).
     Например, %E2 означает что принимаются коды завершения 0, 1 и 2.
     Эта переменная может быть указана в любом месте команды. Если она 
     отсутствует, только код завершения 0 распознается как успешный.
%O - По умолчанию, MultiArc преобразует вывод архиватора из OEM кодировки 
     (DOS) в ANSI (Windows). Применяйте его для пропуска преобразования.
%R - целевая поддиректория В архиве
{} - если некоторые переменные заключены в фигурные скобки она будет 
     добавлена только если  эта переменная содержит что-либо не пустое. Смотрите 
     MsCAB addon для примера использования. ВНИМАНИЕ - сейчас работает только с
     переменной %R. 
%S - Зависит от режима, устанавливается в диалоге Настройка MultiArc, MultiArc будет 
     запрашивать пользователя дополнительные параметры командной строки, которые 
     должны быть размещены на месте %S.
%C - Не скрывать окно консоли во время выполнения внешнего архиватора. Настройка консоли
     имеет больше настраиваемых параметров, см диалог Настройка MultiArc.

модификаторы переменных Q, q, W, P, A могут быть использованы для изменения формата имен 
файлов: 
Q - Заключать в кавычки имена с пробелами;
q - Заключать в кавычки все имена;
W - Использовать только имена, без пути;
P - Использовать только путь, без имени;
A - Использовать ANSI кодировку.

Эти модификаторы могут быть указаны сразу после переменной, без пробелов.

Примечание:
Если у вас архиватор находится в пути с русскими буквами (по логике с любым путем, содержащим символы не английского алфавита и цифры) и вы получаете сообщение наподобие такого: 

"Executing command 'C:\Documents and Settings\Ђ¤¬Ё­Ёбва в(r)а\ђ Ў(r)зЁ(c) бв(r)"\7za.exe -r0 l D:\Это тест русских имен TC\7zSfx.7z' returned errorlevel -1. Possibly an error occurred. Archive listing wasn't retrieved."
либо такого: 
"Executed command 'C:\Documents and Settings\Ђ¤¬Ё­Ёбва в(r)а\ђ Ў(r)зЁ(c) бв(r)"\7za.exe -r0 l D:\Это тест русских имен TC\7zSfx.7z' returned errorlevel -1, which is higher than configured as normal for this command. Probably error occurred. Check your configuration, please..."

Замените в Multiarc.ini в секции соответствующего архиватора параметры Extract, ExtractWithPath, Test, Delete, Add с %Р на %PA или %PQA. 
